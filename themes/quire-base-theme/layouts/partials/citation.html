{{/*

    Template for the "Cite this Page" feature. Called as a
    partial, such as:

    partial "citation.html" (dict "citeScope" . "citeType" "chicago" )

    Can accept "chicago" or "mla" as a citeType

    Follows Getty standard of using "et al" for more than three
    authors in Chicago citations, and more than two authors
    in MLA citations.

    Currently uses a `publisher_citation_chicago` value in
    `publication.yml` to properly concatenate multiple publishers
    in the same location. Though this should certainly be
    addressable in the template itself down the road.

*/}}
{{ $citeType := .citeType }}
{{ $citeScope := .citeScope }}

{{ if eq $citeType "chicago" }}

  {{ if $citeScope.Page.Params.contributor }}

    {{ template "page-author-chicago" $citeScope.Page.Params.contributor }}

    “{{ partial "full-title.html" $citeScope.Page.Params }}.”

    In <em>{{ partial "full-title.html" $citeScope.Site.Data.publication }}</em>,

    by {{ template "book-author-chicago" $citeScope.Site.Data.publication.primary_contributor }}

    {{ $pubLen := len $citeScope.Site.Data.publication.publisher -}}
    {{ if $citeScope.Site.Data.publication.publisher_citation_chicago }}
      {{ $citeScope.Site.Data.publication.publisher_citation_chicago }},
    {{ else }}
      {{ range $index, $element := $citeScope.Site.Data.publication.publisher }}
        {{ .location }}: {{ .name }}{{ if eq $index (sub $pubLen 1) }},{{ else }};{{ end }}
      {{ end }}
    {{ end }}

    {{ $citeScope.Site.Data.publication.pub_date | dateFormat "2006" }}.

    <span class="force-wrap">{{ $citeScope.Site.Data.publication.url }}{{ $citeScope.Page.RelPermalink }}</span>.

  {{ else }}

    {{ template "page-author-chicago" $citeScope.Site.Data.publication.primary_contributor }}

    “{{ partial "full-title.html" $citeScope.Page.Params }}.”

    In <em>{{ partial "full-title.html" $citeScope.Site.Data.publication }}</em>.

    {{ $pubLen := len $citeScope.Site.Data.publication.publisher -}}
    {{ if $citeScope.Site.Data.publication.publisher_citation_chicago }}
      {{ $citeScope.Site.Data.publication.publisher_citation_chicago }},
    {{ else }}
      {{ range $index, $element := $citeScope.Site.Data.publication.publisher }}
        {{ .location }}: {{ .name }}{{ if eq $index (sub $pubLen 1) }},{{ else }};{{ end }}
      {{ end }}
    {{ end }}

    {{ $citeScope.Site.Data.publication.pub_date | dateFormat "2006" }}.

    <span class="force-wrap">{{ $citeScope.Site.Data.publication.url }}{{ $citeScope.Page.RelPermalink }}</span>.

  {{- end }}

{{ end }}


{{ if eq $citeType "mla" }}

  {{ if $citeScope.Page.Params.contributor }}

    {{ template "page-author-mla" $citeScope.Page.Params.contributor }}

    “{{ partial "full-title.html" $citeScope.Page.Params }}.”

    <em>{{ partial "full-title.html" $citeScope.Site.Data.publication }}</em>.

    By {{ template "book-author-mla" $citeScope.Site.Data.publication.primary_contributor }}

    {{ range $citeScope.Site.Data.publication.publisher }}
      {{ .name }},
    {{ end }}

    {{ $citeScope.Site.Data.publication.pub_date | dateFormat "2006" }},

    <span class="cite-current-date" id="js-date">D MMMM YYYY</span>,

    <span class="force-wrap">{{ $citeScope.Site.Data.publication.url }}{{ $citeScope.Page.RelPermalink }}</span>.

  {{ else }}

    {{ template "page-author-mla" $citeScope.Site.Data.publication.primary_contributor }}

    “{{ partial "full-title.html" $citeScope.Page.Params }}.”

    <em>{{ partial "full-title.html" $citeScope.Site.Data.publication }}</em>.

    {{ range $citeScope.Site.Data.publication.publisher }}
      {{ .name }},
    {{ end }}

    {{ $citeScope.Site.Data.publication.pub_date | dateFormat "2006" }},

    <span class="cite-current-date" id="js-date">D MMMM YYYY</span>,

    <span class="force-wrap">{{ $citeScope.Site.Data.publication.url }}{{ $citeScope.Page.RelPermalink }}</span>.

  {{ end }}

{{ end }}



{{ define "page-author-chicago" }}
  {{ $len := len . -}}
  {{ range $index, $element := . }}
    {{- if eq $len 1 -}}
      {{- $endPunctuation := findRE "[[:punct:]]$" .first_name -}}
      {{ .last_name }}, {{ .first_name }}
      {{ if $endPunctuation }}{{ else }}.{{ end }}
    {{- else if and (gt $len 1) (eq $index 0) -}}
      {{ .last_name }}, {{ .first_name }}
    {{- else if and (eq $len 3) (eq $index 1) -}}
      , {{ .first_name }} {{ .last_name }}
    {{- else if or (eq $len 2) (and (eq $len 3) (eq $index 2)) -}}
      , and {{ .first_name }} {{ .last_name }}.
    {{- end -}}
  {{- end -}}
  {{- if gt $len 3 -}}
    , et al.
  {{- end -}}
{{ end }}

{{ define "book-author-chicago" }}
  {{ $len := len . -}}
  {{ range $index, $element := . }}
    {{- if eq $len 1 -}}
      {{- $endPunctuation := findRE "[[:punct:]]$" .first_name -}}
      {{ .first_name }} {{ .last_name }}.
    {{- else if and (gt $len 1) (eq $index 0) -}}
      {{ .first_name }} {{ .last_name }}
    {{- else if and (eq $len 3) (eq $index 1) -}}
      , {{ .first_name }} {{ .last_name }}
    {{- else if or (eq $len 2) (and (eq $len 3) (eq $index 2)) -}}
      , and {{ .first_name }} {{ .last_name }}.
    {{- end -}}
  {{- end -}}
  {{- if gt $len 3 -}}
    , et al.
  {{- end -}}
{{ end }}

{{ define "page-author-mla" }}
  {{ $len := len . -}}
  {{ range $index, $element := . }}
    {{- if eq $len 1 -}}
      {{- $endPunctuation := findRE "[[:punct:]]$" .first_name -}}
      {{ .last_name }}, {{ .first_name }}
      {{ if $endPunctuation }}{{ else }}.{{ end }}
    {{- else if and (gt $len 1) (eq $index 0) -}}
      {{ .last_name }}, {{ .first_name }}
    {{- else if or (eq $len 2) (and (eq $len 2) (eq $index 1)) -}}
      , and {{ .first_name }} {{ .last_name }}.
    {{- end -}}
  {{- end -}}
  {{- if gt $len 2 -}}
    , et al.
  {{- end -}}
{{ end }}

{{ define "book-author-mla" }}
  {{ $len := len . -}}
  {{ range $index, $element := . }}
    {{- if eq $len 1 -}}
      {{- $endPunctuation := findRE "[[:punct:]]$" .first_name -}}
      {{ .first_name }} {{ .last_name }}.
    {{- else if and (gt $len 1) (eq $index 0) -}}
      {{ .first_name }} {{ .last_name }}
    {{- else if or (eq $len 2) (and (eq $len 2) (eq $index 1)) -}}
      , and {{ .first_name }} {{ .last_name }}.
    {{- end -}}
  {{- end -}}
  {{- if gt $len 2 -}}
    , et al.
  {{- end -}}
{{ end }}
